<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const isDarkMode = localStorage.getItem('darkMode') === 'true';
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
        })();
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">üì¶ Smart Inventory</a>
            <span class="navbar-text">ML-Powered Predictive Restocking</span>
            <button class="theme-toggle" onclick="toggleTheme()">
                <span id="themeIcon">üåô</span>
            </button>
        </div>
    </nav>

    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">‚ûï Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="newProductName" placeholder="Product Name">
                    <input type="text" class="form-control mb-3" id="newProductCategory" placeholder="Category">
                    <input type="number" class="form-control mb-3" id="newProductPrice" placeholder="Price" step="0.01">
                    <select class="form-select mb-3" id="newProductSupplier">
                        <option value="">Select Supplier</option>
                    </select>
                    <input type="number" class="form-control mb-3" id="newProductQuantity" placeholder="Initial Stock" value="100">
                    <div class="row">
                        <div class="col-6"><input type="number" class="form-control" id="newProductMinStock" placeholder="Min Stock" value="50"></div>
                        <div class="col-6"><input type="number" class="form-control" id="newProductReorder" placeholder="Reorder Point" value="75"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewProduct()">Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recordSaleModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">üí≥ Record Sale</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select class="form-select mb-3" id="saleProductSelect">
                        <option value="">Select Product</option>
                    </select>
                    <input type="number" class="form-control mb-3" id="saleQuantity" placeholder="Quantity Sold" min="1">
                    <div class="mb-3">
                        <label>Amount: <span id="saleAmount">$0.00</span></label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="recordSale()">Record Sale</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid main-content">
        <div class="header-section">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1>üìä Dashboard</h1>
                <div class="btn-group">
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#recordSaleModal">üí≥ Record Sale</button>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addProductModal">‚ûï Add Product</button>
                </div>
            </div>
        </div>

        <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="total-products">-</div>
                <div class="stat-label">Total Products</div>
                <div class="stat-icon">üì¶</div>
            </div>
            <div class="stat-card alert">
                <div class="stat-value" id="low-stock-alerts">-</div>
                <div class="stat-label">Low Stock Alerts</div>
                <div class="stat-icon">‚ö†Ô∏è</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="weekly-sales">-</div>
                <div class="stat-label">Weekly Sales</div>
                <div class="stat-icon">üí∞</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card-section">
                <div class="section-header">üö® Restock Alerts</div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                                <th>Reorder</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody id="restock-alerts-table">
                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section">
                <div class="section-header">üîÆ Demand Prediction</div>
                <select class="form-select mb-2" id="product-select">
                    <option value="">Select Product</option>
                </select>
                <input type="number" class="form-control mb-3" id="days-ahead" value="7" min="1" max="30">
                <button class="btn btn-primary w-100" onclick="predictDemand()">Predict</button>
                <div id="prediction-result" style="display: none; margin-top: 15px;">
                    <div id="prediction-values"></div>
                </div>
            </div>
        </div>

        <div class="card-section full-width">
            <div class="section-header">üìà Prediction Chart</div>
            <canvas id="demandChart"></canvas>
        </div>

        <div class="content-grid">
            <div class="card-section full-width">
                <div class="section-header">üì¶ All Products</div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Min</th>
                                <th>Reorder</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="products-table">
                            <tr><td colspan="8" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section full-width">
                <div class="section-header">üí≥ Recent Sales & Billing</div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Product</th>
                                <th>Quantity</th>
                                <th>Unit Price</th>
                                <th>Total Amount</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-table">
                            <tr><td colspan="5" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section">
                <div class="section-header">üèÜ Top Products</div>
                <ul class="top-list" id="top-products-list">
                    <li>Loading...</li>
                </ul>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let demandChart = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let allProducts = [];

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('themeIcon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('darkMode', isDarkMode);
            if (demandChart) updateChartTheme();
        }

        function updateChartTheme() {
            if (!demandChart) return;
            const textColor = isDarkMode ? '#ffffff' : '#1a202c';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            demandChart.options.scales.x.ticks.color = textColor;
            demandChart.options.scales.y.ticks.color = textColor;
            demandChart.options.scales.x.grid.color = gridColor;
            demandChart.options.scales.y.grid.color = gridColor;
            demandChart.options.plugins.legend.labels.color = textColor;
            demandChart.update();
        }

        async function loadDashboardStats() {
            try {
                const res = await fetch('/api/dashboard-stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('total-products').textContent = data.total_products;
                    document.getElementById('low-stock-alerts').textContent = data.low_stock_alerts;
                    document.getElementById('weekly-sales').textContent = '$' + data.weekly_sales.toLocaleString('en-US', {minimumFractionDigits: 2});
                    const medals = ['ü•á', 'ü•à', 'ü•â', '4Ô∏è‚É£', '5Ô∏è‚É£'];
                    const list = document.getElementById('top-products-list');
                    list.innerHTML = data.top_products.map((p, i) => `<li>${medals[i] || 'üì¶'} ${p.product_name} (${p.total_sold})</li>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const data = await res.json();
                if (data.success) {
                    allProducts = data.products;
                    const tbody = document.getElementById('products-table');
                    tbody.innerHTML = data.products.map(p => {
                        const status = p.quantity_available <= p.reorder_point ? 'RESTOCK' : p.quantity_available <= p.minimum_stock_level * 1.2 ? 'Low' : 'OK';
                        return `<tr><td>#${p.product_id}</td><td>${p.product_name}</td><td>${p.category}</td><td>$${p.unit_price.toFixed(2)}</td><td>${p.quantity_available}</td><td>${p.minimum_stock_level}</td><td>${p.reorder_point}</td><td><span class="badge">${status}</span></td></tr>`;
                    }).join('');
                    const select = document.getElementById('product-select');
                    select.innerHTML = '<option value="">Select Product</option>' + data.products.map(p => `<option value="${p.product_id}">${p.product_name}</option>`).join('');
                    const saleSelect = document.getElementById('saleProductSelect');
                    if (saleSelect) saleSelect.innerHTML = '<option value="">Select Product</option>' + data.products.map(p => `<option value="${p.product_id}">${p.product_name} ($${p.unit_price.toFixed(2)})</option>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadRestockAlerts() {
            try {
                const res = await fetch('/api/restock-alerts');
                const data = await res.json();
                const tbody = document.getElementById('restock-alerts-table');
                if (data.success) {
                    tbody.innerHTML = data.alerts.length === 0 ? '<tr><td colspan="4" class="text-center">‚úÖ All products well-stocked!</td></tr>' : data.alerts.map(a => `<tr><td>${a.product_name}</td><td>${a.quantity_available}</td><td>${a.reorder_point}</td><td>${a.supplier_name}</td></tr>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadSuppliers() {
            try {
                const res = await fetch('/api/suppliers');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('newProductSupplier');
                    select.innerHTML = '<option value="">Select Supplier</option>' + data.suppliers.map(s => `<option value="${s.supplier_id}">${s.supplier_name}</option>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadRecentSales() {
            try {
                const res = await fetch('/api/recent-sales');
                const data = await res.json();
                if (data.success) {
                    const tbody = document.getElementById('sales-history-table');
                    tbody.innerHTML = data.sales.length === 0 ? '<tr><td colspan="5" class="text-center">No sales recorded yet</td></tr>' : data.sales.map(s => {
                        const date = new Date(s.sale_date).toLocaleDateString();
                        return `<tr><td>${date}</td><td>${s.product_name}</td><td>${s.quantity_sold}</td><td>$${(s.total_amount / s.quantity_sold).toFixed(2)}</td><td>$${s.total_amount.toFixed(2)}</td></tr>`;
                    }).join('');
                }
            } catch (e) { console.error(e); }
        }

        function updateSaleAmount() {
            const productId = document.getElementById('saleProductSelect').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            if (productId) {
                const product = allProducts.find(p => p.product_id === parseInt(productId));
                if (product) {
                    const amount = product.unit_price * quantity;
                    document.getElementById('saleAmount').textContent = '$' + amount.toFixed(2);
                }
            } else {
                document.getElementById('saleAmount').textContent = '$0.00';
            }
        }

        async function recordSale() {
            const productId = document.getElementById('saleProductSelect').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            if (!productId || !quantity || quantity <= 0) { alert('Select product and enter quantity'); return; }
            try {
                const res = await fetch('/api/add-sale', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: parseInt(productId), quantity_sold: quantity})
                });
                const data = await res.json();
                if (data.success) {
                    alert(`‚úÖ Sale recorded! Amount: $${data.total_amount.toFixed(2)}`);
                    bootstrap.Modal.getInstance(document.getElementById('recordSaleModal')).hide();
                    document.getElementById('saleProductSelect').value = '';
                    document.getElementById('saleQuantity').value = '';
                    document.getElementById('saleAmount').textContent = '$0.00';
                    loadDashboardStats(); loadProducts(); loadRestockAlerts(); loadRecentSales();
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        async function predictDemand() {
            const productId = document.getElementById('product-select').value;
            const daysAhead = parseInt(document.getElementById('days-ahead').value);
            if (!productId) { alert('Select a product'); return; }
            try {
                const res = await fetch('/api/predict-demand', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: parseInt(productId), days_ahead: daysAhead})
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('prediction-values').innerHTML = data.predictions.map((p, i) => `<div class="pred-day">Day ${i+1}: <strong>${p}</strong></div>`).join('');
                    document.getElementById('prediction-result').style.display = 'block';
                    updateDemandChart(data.predictions, daysAhead, data.product_name);
                }
            } catch (e) { console.error(e); }
        }

        function updateDemandChart(predictions, days, productName) {
            const ctx = document.getElementById('demandChart').getContext('2d');
            const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
            const textColor = isDarkMode ? '#ffffff' : '#1a202c';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            if (demandChart) demandChart.destroy();
            demandChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels, datasets: [{
                        label: 'Predicted Demand',
                        data: predictions,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: textColor, font: { family: 'Inter', weight: '600' } } },
                        title: { display: true, text: `Forecast: ${productName}`, color: textColor }
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }

        async function saveNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const category = document.getElementById('newProductCategory').value.trim();
            const price = document.getElementById('newProductPrice').value;
            const supplier = document.getElementById('newProductSupplier').value;
            if (!name || !category || !price || !supplier) { alert('Fill all fields'); return; }
            try {
                const res = await fetch('/api/add-product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_name: name, category, unit_price: parseFloat(price),
                        supplier_id: parseInt(supplier),
                        initial_quantity: parseInt(document.getElementById('newProductQuantity').value),
                        min_stock_level: parseInt(document.getElementById('newProductMinStock').value),
                        reorder_point: parseInt(document.getElementById('newProductReorder').value)
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('‚úÖ Product added!');
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadDashboardStats(); loadProducts(); loadRestockAlerts();
                    ['newProductName', 'newProductCategory', 'newProductPrice', 'newProductSupplier', 'newProductQuantity', 'newProductMinStock', 'newProductReorder'].forEach(id => {
                        const el = document.getElementById(id);
                        el.value = id === 'newProductQuantity' ? '100' : id === 'newProductMinStock' ? '50' : id === 'newProductReorder' ? '75' : '';
                    });
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats(); loadProducts(); loadRestockAlerts(); loadSuppliers(); loadRecentSales();
            document.getElementById('saleProductSelect').addEventListener('change', updateSaleAmount);
            document.getElementById('saleQuantity').addEventListener('input', updateSaleAmount);
            setInterval(() => { loadDashboardStats(); loadRestockAlerts(); loadRecentSales(); }, 60000);
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Inventory Management System</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        (function() {
            const isDarkMode = localStorage.getItem('darkMode') !== 'false';
            if (isDarkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
            }
        })();
    </script>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">Smart Inventory</a>
            <div class="ms-auto theme-toggle-container">
                <input type="checkbox" id="themeToggle" class="theme-toggle-checkbox" onchange="toggleTheme()">
                <label for="themeToggle" class="theme-toggle-label"></label>
            </div>
        </div>
    </nav>

    <div class="modal fade" id="addProductModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Add New Product</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="text" class="form-control mb-3" id="newProductName" placeholder="Product Name">
                    <input type="text" class="form-control mb-3" id="newProductCategory" placeholder="Category">
                    <input type="number" class="form-control mb-3" id="newProductPrice" placeholder="Price" step="0.01">
                    <select class="form-select mb-3" id="newProductSupplier">
                        <option value="">Select Supplier</option>
                    </select>
                    <input type="number" class="form-control mb-3" id="newProductQuantity" placeholder="Initial Stock" value="100">
                    <div class="row">
                        <div class="col-6"><input type="number" class="form-control" id="newProductMinStock" placeholder="Min Stock" value="50"></div>
                        <div class="col-6"><input type="number" class="form-control" id="newProductReorder" placeholder="Reorder Point" value="75"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewProduct()">Add Product</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="recordPurchaseModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Update Stock</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <select class="form-select mb-3" id="purchaseProductSelect">
                        <option value="">Select Product</option>
                    </select>
                    <input type="number" class="form-control mb-3" id="purchaseQuantity" placeholder="Quantity Purchased" min="1">
                    <div class="mb-3">
                        <label>Cost: <span id="purchaseCost">â‚¹0.00</span></label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="recordPurchase()">Update Stock</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid main-content">
        <div class="header-section">
            <div class="d-flex justify-content-end align-items-center mb-4 gap-3">
                <button class="btn btn-secondary-custom" data-bs-toggle="modal" data-bs-target="#recordPurchaseModal">Update Stock</button>
                <button class="btn btn-primary-custom" data-bs-toggle="modal" data-bs-target="#addProductModal">Add Product</button>
            </div>
        </div>

        <ul class="nav nav-tabs mb-4" role="tablist" style="border-bottom: 2px solid #e0e0e0;">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard-content" type="button" role="tab">Dashboard</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="sales-tab" data-bs-toggle="tab" data-bs-target="#sales-content" type="button" role="tab">Record Sale</button>
            </li>
        </ul>

        <div class="tab-content">
            <div class="tab-pane fade show active" id="dashboard-content" role="tabpanel">
                <div class="stats-row">
            <div class="stat-card">
                <div class="stat-value" id="total-products">-</div>
                <div class="stat-label">Total Products</div>
                <div class="stat-icon">ðŸ“Š</div>
            </div>
            <div class="stat-card alert">
                <div class="stat-value" id="low-stock-alerts">-</div>
                <div class="stat-label">Low Stock Alerts</div>
                <div class="stat-icon">!</div>
            </div>
            <div class="stat-card success">
                <div class="stat-value" id="weekly-sales">-</div>
                <div class="stat-label">Weekly Sales</div>
                <div class="stat-icon">â‚¹</div>
            </div>
        </div>

        <div class="content-grid">
            <div class="card-section">
                <div class="section-header">Restock Alerts</div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Product</th>
                                <th>Stock</th>
                                <th>Reorder</th>
                                <th>Supplier</th>
                            </tr>
                        </thead>
                        <tbody id="restock-alerts-table">
                            <tr><td colspan="4" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section">
                <div class="section-header">Demand Forecast</div>
                <select class="form-select mb-2" id="product-select">
                    <option value="">Select Product</option>
                </select>
                <input type="number" class="form-control mb-3" id="days-ahead" value="7" min="1" max="30">
                <button class="btn btn-primary w-100" onclick="predictDemand()">Predict</button>
                <div id="prediction-result" style="display: none; margin-top: 15px;">
                    <div id="prediction-values"></div>
                </div>
            </div>
        </div>

        <div class="card-section full-width">
            <div class="section-header">Forecast Chart</div>
            <canvas id="demandChart"></canvas>
        </div>

        <div class="content-grid">
            <div class="card-section full-width">
                <div class="section-header">All Products</div>
                <div class="table-wrapper">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Product</th>
                                <th>Category</th>
                                <th>Price</th>
                                <th>Stock</th>
                                <th>Min</th>
                                <th>Reorder</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="products-table">
                            <tr><td colspan="8" class="text-center">Loading...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="card-section">
                <div class="section-header">Top Products</div>
                <canvas id="topProductsChart" style="max-height: 300px;"></canvas>
            </div>
        </div>
            </div>

            <div class="tab-pane fade" id="sales-content" role="tabpanel">
                <div class="card-section" style="max-width: 600px;">
                    <div class="section-header">Record Sale</div>
                    <div style="padding: 20px;">
                        <select class="form-select mb-3" id="saleProductSelect">
                            <option value="">Select Product</option>
                        </select>
                        <input type="number" class="form-control mb-3" id="saleQuantity" placeholder="Quantity Sold" min="1">
                        <div class="mb-3">
                            <label>Amount: <span id="saleAmount">â‚¹0.00</span></label>
                        </div>
                        <button class="btn btn-primary w-100" onclick="recordSale()">Record Sale</button>
                    </div>
                </div>

                <div class="card-section full-width" style="margin-top: 30px;">
                    <div class="section-header">Recent Sales & Billing</div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Product</th>
                                    <th>Quantity</th>
                                    <th>Unit Price</th>
                                    <th>Total Amount</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody id="sales-history-table">
                                <tr><td colspan="6" class="text-center">Loading...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let demandChart = null;
        let topProductsChart = null;
        let isDarkMode = localStorage.getItem('darkMode') === 'true';
        let allProducts = [];

        function formatIndianNumber(number) {
            if (number >= 10000000) {
                return (number / 10000000).toFixed(2) + ' Cr';
            } else if (number >= 100000) {
                return (number / 100000).toFixed(2) + ' L';
            } else {
                return number.toFixed(2);
            }
        }

        function toggleTheme() {
            isDarkMode = !isDarkMode;
            document.documentElement.setAttribute('data-theme', isDarkMode ? 'dark' : 'light');
            document.getElementById('themeToggle').checked = isDarkMode;
            localStorage.setItem('darkMode', isDarkMode);
            if (demandChart) updateChartTheme();
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('themeToggle').checked = isDarkMode;
        });

        function updateChartTheme() {
            const textColor = isDarkMode ? '#ffffff' : '#1a202c';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            if (demandChart) {
                demandChart.options.scales.x.ticks.color = textColor;
                demandChart.options.scales.y.ticks.color = textColor;
                demandChart.options.scales.x.grid.color = gridColor;
                demandChart.options.scales.y.grid.color = gridColor;
                demandChart.options.plugins.legend.labels.color = textColor;
                demandChart.update();
            }
            if (topProductsChart) {
                topProductsChart.options.scales.x.ticks.color = textColor;
                topProductsChart.options.scales.y.ticks.color = textColor;
                topProductsChart.options.scales.x.grid.color = gridColor;
                topProductsChart.options.scales.y.grid.color = gridColor;
                topProductsChart.options.plugins.legend.labels.color = textColor;
                topProductsChart.update();
            }
        }

        async function loadDashboardStats() {
            try {
                const res = await fetch('/api/dashboard-stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('total-products').textContent = data.total_products;
                    document.getElementById('low-stock-alerts').textContent = data.low_stock_alerts;
                    document.getElementById('weekly-sales').textContent = 'â‚¹' + formatIndianNumber(data.weekly_sales);
                    
                    const textColor = isDarkMode ? '#ffffff' : '#1a202c';
                    const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
                    const ctx = document.getElementById('topProductsChart').getContext('2d');
                    
                    if (topProductsChart) topProductsChart.destroy();
                    topProductsChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: data.top_products.map(p => p.product_name),
                            datasets: [{
                                label: 'Units Sold',
                                data: data.top_products.map(p => p.total_sold),
                                backgroundColor: '#667eea',
                                borderColor: '#6b7dff',
                                borderWidth: 1,
                                borderRadius: 8
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: true,
                            plugins: {
                                legend: { labels: { color: textColor } }
                            },
                            scales: {
                                x: {
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                },
                                y: {
                                    ticks: { color: textColor },
                                    grid: { color: gridColor }
                                }
                            }
                        }
                    });
                }
            } catch (e) { console.error(e); }
        }

        async function loadProducts() {
            try {
                const res = await fetch('/api/products');
                const data = await res.json();
                if (data.success) {
                    allProducts = data.products;
                    const tbody = document.getElementById('products-table');
                    tbody.innerHTML = data.products.map(p => {
                        const status = p.quantity_available <= p.reorder_point ? 'RESTOCK' : p.quantity_available <= p.minimum_stock_level * 1.2 ? 'Low' : 'OK';
                        return `<tr><td>#${p.product_id}</td><td>${p.product_name}</td><td>${p.category}</td><td>â‚¹${p.unit_price.toFixed(2)}</td><td>${p.quantity_available}</td><td>${p.minimum_stock_level}</td><td>${p.reorder_point}</td><td><span class="badge">${status}</span></td></tr>`;
                    }).join('');
                    const select = document.getElementById('product-select');
                    select.innerHTML = '<option value="">Select Product</option>' + data.products.map(p => `<option value="${p.product_id}">${p.product_name}</option>`).join('');
                    const saleSelect = document.getElementById('saleProductSelect');
                    if (saleSelect) saleSelect.innerHTML = '<option value="">Select Product</option>' + data.products.map(p => `<option value="${p.product_id}">${p.product_name} (â‚¹${p.unit_price.toFixed(2)})</option>`).join('');
                    const purchaseSelect = document.getElementById('purchaseProductSelect');
                    if (purchaseSelect) purchaseSelect.innerHTML = '<option value="">Select Product</option>' + data.products.map(p => `<option value="${p.product_id}">${p.product_name} (â‚¹${p.unit_price.toFixed(2)})</option>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadRestockAlerts() {
            try {
                const res = await fetch('/api/restock-alerts');
                const data = await res.json();
                const tbody = document.getElementById('restock-alerts-table');
                if (data.success) {
                    tbody.innerHTML = data.alerts.length === 0 ? '<tr><td colspan="4" class="text-center">All products well-stocked</td></tr>' : data.alerts.map(a => `<tr><td>${a.product_name}</td><td>${a.quantity_available}</td><td>${a.reorder_point}</td><td>${a.supplier_name}</td></tr>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadSuppliers() {
            try {
                const res = await fetch('/api/suppliers');
                const data = await res.json();
                if (data.success) {
                    const select = document.getElementById('newProductSupplier');
                    select.innerHTML = '<option value="">Select Supplier</option>' + data.suppliers.map(s => `<option value="${s.supplier_id}">${s.supplier_name}</option>`).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function loadRecentSales() {
            try {
                const res = await fetch('/api/recent-sales');
                const data = await res.json();
                if (data.success) {
                    const tbody = document.getElementById('sales-history-table');
                    tbody.innerHTML = data.sales.length === 0 ? '<tr><td colspan="6" class="text-center">No sales recorded yet</td></tr>' : data.sales.map(s => {
                        const date = new Date(s.sale_date).toLocaleDateString();
                        return `<tr><td>${date}</td><td>${s.product_name}</td><td>${s.quantity_sold}</td><td>â‚¹${(s.total_amount / s.quantity_sold).toFixed(2)}</td><td>â‚¹${s.total_amount.toFixed(2)}</td><td><button class="btn btn-sm btn-danger" onclick="deleteSale('${s.sale_id}')">Delete</button></td></tr>`;
                    }).join('');
                }
            } catch (e) { console.error(e); }
        }

        async function deleteSale(saleId) {
            if (!confirm('Are you sure you want to delete this sale? This will also restore the inventory quantity.')) return;
            try {
                const res = await fetch('/api/delete-sale', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({sale_id: saleId})
                });
                const data = await res.json();
                if (data.success) {
                    alert('Sale deleted and inventory restored');
                    loadDashboardStats(); loadProducts(); loadRestockAlerts(); loadRecentSales();
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        function updateSaleAmount() {
            const productId = document.getElementById('saleProductSelect').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value) || 0;
            if (productId) {
                const product = allProducts.find(p => p.product_id === parseInt(productId));
                if (product) {
                    const amount = product.unit_price * quantity;
                    document.getElementById('saleAmount').textContent = 'â‚¹' + amount.toFixed(2);
                }
            } else {
                document.getElementById('saleAmount').textContent = 'â‚¹0.00';
            }
        }

        function updatePurchaseCost() {
            const productId = document.getElementById('purchaseProductSelect').value;
            const quantity = parseInt(document.getElementById('purchaseQuantity').value) || 0;
            if (productId) {
                const product = allProducts.find(p => p.product_id === parseInt(productId));
                if (product) {
                    const cost = product.unit_price * quantity;
                    document.getElementById('purchaseCost').textContent = 'â‚¹' + cost.toFixed(2);
                }
            } else {
                document.getElementById('purchaseCost').textContent = 'â‚¹0.00';
            }
        }

        async function recordPurchase() {
            const productId = document.getElementById('purchaseProductSelect').value;
            const quantity = parseInt(document.getElementById('purchaseQuantity').value);
            if (!productId || !quantity || quantity <= 0) { alert('Select product and enter quantity'); return; }
            try {
                const res = await fetch('/api/add-purchase', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: parseInt(productId), quantity_purchased: quantity})
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Stock updated! Added ${quantity} units. New Stock: ${data.new_quantity}`);
                    bootstrap.Modal.getInstance(document.getElementById('recordPurchaseModal')).hide();
                    document.getElementById('purchaseProductSelect').value = '';
                    document.getElementById('purchaseQuantity').value = '';
                    document.getElementById('purchaseCost').textContent = 'â‚¹0.00';
                    loadDashboardStats(); loadProducts(); loadRestockAlerts();
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        async function recordSale() {
            const productId = document.getElementById('saleProductSelect').value;
            const quantity = parseInt(document.getElementById('saleQuantity').value);
            if (!productId || !quantity || quantity <= 0) { alert('Select product and enter quantity'); return; }
            try {
                const res = await fetch('/api/add-sale', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: parseInt(productId), quantity_sold: quantity})
                });
                const data = await res.json();
                if (data.success) {
                    alert(`Sale recorded! Amount: â‚¹${data.total_amount.toFixed(2)}`);
                    document.getElementById('saleProductSelect').value = '';
                    document.getElementById('saleQuantity').value = '';
                    document.getElementById('saleAmount').textContent = 'â‚¹0.00';
                    loadDashboardStats(); loadProducts(); loadRestockAlerts(); loadRecentSales();
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        async function predictDemand() {
            const productId = document.getElementById('product-select').value;
            const daysAhead = parseInt(document.getElementById('days-ahead').value);
            if (!productId) { alert('Select a product'); return; }
            try {
                const res = await fetch('/api/predict-demand', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({product_id: parseInt(productId), days_ahead: daysAhead})
                });
                const data = await res.json();
                if (data.success) {
                    document.getElementById('prediction-values').innerHTML = data.predictions.map((p, i) => `<div class="pred-day">Day ${i+1}: <strong>${p}</strong></div>`).join('');
                    document.getElementById('prediction-result').style.display = 'block';
                    updateDemandChart(data.predictions, daysAhead, data.product_name);
                }
            } catch (e) { console.error(e); }
        }

        function updateDemandChart(predictions, days, productName) {
            const ctx = document.getElementById('demandChart').getContext('2d');
            const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
            const textColor = isDarkMode ? '#ffffff' : '#1a202c';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';
            
            if (demandChart) demandChart.destroy();
            demandChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels, datasets: [{
                        label: 'Predicted Demand',
                        data: predictions,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102,126,234,0.1)',
                        tension: 0.4,
                        fill: true,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#fff',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { labels: { color: textColor, font: { family: 'Inter', weight: '600' } } },
                        title: { display: true, text: `Forecast: ${productName}`, color: textColor }
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: { beginAtZero: true, ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }

        async function saveNewProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const category = document.getElementById('newProductCategory').value.trim();
            const price = document.getElementById('newProductPrice').value;
            const supplier = document.getElementById('newProductSupplier').value;
            if (!name || !category || !price || !supplier) { alert('Fill all fields'); return; }
            try {
                const res = await fetch('/api/add-product', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        product_name: name, category, unit_price: parseFloat(price),
                        supplier_id: parseInt(supplier),
                        initial_quantity: parseInt(document.getElementById('newProductQuantity').value),
                        min_stock_level: parseInt(document.getElementById('newProductMinStock').value),
                        reorder_point: parseInt(document.getElementById('newProductReorder').value)
                    })
                });
                const data = await res.json();
                if (data.success) {
                    alert('âœ… Product added!');
                    bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
                    loadDashboardStats(); loadProducts(); loadRestockAlerts();
                    ['newProductName', 'newProductCategory', 'newProductPrice', 'newProductSupplier', 'newProductQuantity', 'newProductMinStock', 'newProductReorder'].forEach(id => {
                        const el = document.getElementById(id);
                        el.value = id === 'newProductQuantity' ? '100' : id === 'newProductMinStock' ? '50' : id === 'newProductReorder' ? '75' : '';
                    });
                } else alert('Error: ' + data.error);
            } catch (e) { console.error(e); }
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadDashboardStats(); loadProducts(); loadRestockAlerts(); loadSuppliers(); loadRecentSales();
            document.getElementById('saleProductSelect').addEventListener('change', updateSaleAmount);
            document.getElementById('saleQuantity').addEventListener('input', updateSaleAmount);
            document.getElementById('purchaseProductSelect').addEventListener('change', updatePurchaseCost);
            document.getElementById('purchaseQuantity').addEventListener('input', updatePurchaseCost);
            setInterval(() => { loadDashboardStats(); loadRestockAlerts(); loadRecentSales(); }, 60000);
        });
    </script>
</body>
</html>
